name: "Reusable Terraform workflow"

on:
  workflow_call:
    inputs:
      tf_working_dir:
        required: true
        type: string
      aws_region:
        required: false
        type: string
        default: 'us-east-1'
      terraform_version:
        required: false
        type: string
        default: '1.5.7'
      oidc_role_arn:
        required: false
        type: string
        default: ''
      role_session_name:
        required: false
        type: string
        default: 'gh-actions-terraform'
      auto_apply:
        required: false
        type: boolean
        default: false
      apply_environment:
        required: false
        type: string
        default: 'terraform-apply'

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      plan-name: "tfplan-${{ inputs.tf_working_dir }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Configure AWS credentials (OIDC)
        if: ${{ inputs.oidc_role_arn != '' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ inputs.oidc_role_arn }}
          role-session-name: ${{ inputs.role_session_name }}
          aws-region: ${{ inputs.aws_region }}

      - name: Configure AWS credentials (secrets)
        if: ${{ inputs.oidc_role_arn == '' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Terraform Init
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform init -input=false -no-color
      - name: Terraform Fmt (check)
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform validate -no-color

      - name: Terraform Plan
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform plan -input=false -out=tfplan -no-color

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: "tfplan-${{ inputs.tf_working_dir }}"
          path: ${{ inputs.tf_working_dir }}/tfplan

  apply:
    needs: plan
    runs-on: ubuntu-latest
    if: ${{ inputs.auto_apply == true }}
    environment: ${{ inputs.apply_environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate credentials present
        run: |
          echo "Validating credentials or OIDC role presence..."
          if [ "${{ inputs.oidc_role_arn }}" != "" ] || [ "${{ secrets.OIDC_ROLE_ARN }}" != "" ] || [ "${{ secrets.AWS_ACCESS_KEY_ID }}" != "" -a "${{ secrets.AWS_SECRET_ACCESS_KEY }}" != "" ]; then
            echo "Credentials/Role present"
          else
            echo "ERROR: No OIDC role or AWS secrets configured. Set repo secret OIDC_ROLE_ARN or AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY." >&2
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Configure AWS credentials (OIDC)
        if: ${{ inputs.oidc_role_arn != '' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ inputs.oidc_role_arn }}
          role-session-name: ${{ inputs.role_session_name }}
          aws-region: ${{ inputs.aws_region }}

      - name: Configure AWS credentials (secrets)
        if: ${{ inputs.oidc_role_arn == '' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.plan.outputs.plan-name }}

      - name: Terraform Apply
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform apply -input=false -auto-approve tfplan -no-color
