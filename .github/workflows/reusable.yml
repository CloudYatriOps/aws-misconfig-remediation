name: "Reusable Terraform workflow"

permissions:
  id-token: write
  contents: read

on:
  workflow_call:
    inputs:
      tf_working_dir:
        required: true
        type: string
      aws_region:
        required: false
        type: string
        default: "us-east-1"
      terraform_version:
        required: false
        type: string
        default: "1.5.7"
      oidc_role_arn:
        required: false
        type: string
        default: ""
      role_session_name:
        required: false
        type: string
        default: ""
      auto_apply:
        required: false
        type: boolean
        default: false
      # New input for optional pre-plan commands
      pre_plan_commands:
        required: false
        type: string
        default: ""
    secrets:
      OIDC_ROLE_ARN:
        required: false
      ROLE_SESSION_NAME:
        required: false

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      plan-name: "tfplan-${{ inputs.tf_working_dir }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Determine auth method
        id: auth
        run: |
          oidc_input="${{ inputs.oidc_role_arn }}"
          oidc_secret="${{ secrets.OIDC_ROLE_ARN }}"
          session_input="${{ inputs.role_session_name }}"
          session_secret="${{ secrets.ROLE_SESSION_NAME }}"

          if [ -n "$oidc_input" ]; then
            echo "method=oidc" >> "$GITHUB_OUTPUT"
            echo "role_arn=$oidc_input" >> "$GITHUB_OUTPUT"
          elif [ -n "$oidc_secret" ]; then
            echo "method=oidc" >> "$GITHUB_OUTPUT"
            echo "role_arn=$oidc_secret" >> "$GITHUB_OUTPUT"
          else
            echo "method=keys" >> "$GITHUB_OUTPUT"
          fi

          if [ -n "$session_input" ]; then
            echo "session_name=$session_input" >> "$GITHUB_OUTPUT"
          elif [ -n "$session_secret" ]; then
            echo "session_name=$session_secret" >> "$GITHUB_OUTPUT"
          else
            echo "session_name=gh-actions-terraform" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure AWS credentials (OIDC)
        if: ${{ steps.auth.outputs.method == 'oidc' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.auth.outputs.role_arn }}
          role-session-name: ${{ steps.auth.outputs.session_name }}
          aws-region: ${{ inputs.aws_region }}

      - name: Terraform Init
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform init -input=false -no-color

      - name: Run Pre-Plan Commands
        if: ${{ inputs.pre_plan_commands != '' }}
        working-directory: ${{ inputs.tf_working_dir }}
        run: |
          echo "Executing pre-plan commands..."
          eval "${{ inputs.pre_plan_commands }}"

      - name: Terraform Plan
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform plan -input=false -out=tfplan -no-color

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: "tfplan-${{ inputs.tf_working_dir }}"
          path: ${{ inputs.tf_working_dir }}/tfplan

  apply:
    needs: plan
    runs-on: ubuntu-latest
    if: ${{ inputs.auto_apply == true }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Determine auth method (apply)
        id: auth_apply
        run: |
          oidc_input="${{ inputs.oidc_role_arn }}"
          oidc_secret="${{ secrets.OIDC_ROLE_ARN }}"
          session_input="${{ inputs.role_session_name }}"
          session_secret="${{ secrets.ROLE_SESSION_NAME }}"

          if [ -n "$oidc_input" ]; then
            echo "method=oidc" >> "$GITHUB_OUTPUT"
            echo "role_arn=$oidc_input" >> "$GITHUB_OUTPUT"
          elif [ -n "$oidc_secret" ]; then
            echo "method=oidc" >> "$GITHUB_OUTPUT"
            echo "role_arn=$oidc_secret" >> "$GITHUB_OUTPUT"
          else
            echo "method=keys" >> "$GITHUB_OUTPUT"
          fi

          if [ -n "$session_input" ]; then
            echo "session_name=$session_input" >> "$GITHUB_OUTPUT"
          elif [ -n "$session_secret" ]; then
            echo "session_name=$session_secret" >> "$GITHUB_OUTPUT"
          else
            echo "session_name=gh-actions-terraform" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure AWS credentials (OIDC)
        if: ${{ steps.auth_apply.outputs.method == 'oidc' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.auth_apply.outputs.role_arn }}
          role-session-name: ${{ steps.auth_apply.outputs.session_name }}
          aws-region: ${{ inputs.aws_region }}

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.plan.outputs.plan-name }}
          path: ${{ inputs.tf_working_dir }}

      - name: Verify downloaded plan
        run: |
          echo "Listing files in ${{ inputs.tf_working_dir }}"
          ls -la ${{ inputs.tf_working_dir }}

      - name: Terraform Apply
        working-directory: ${{ inputs.tf_working_dir }}
        run: terraform apply -input=false -auto-approve tfplan -no-color
